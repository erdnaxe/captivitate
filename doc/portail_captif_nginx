upstream app_server {
    server unix:/tmp/gunicorn-portail_captif.sock fail_timeout=0;
}


server {
    listen          80 default_server;
    listen [::]:80;

    return 301 https://portail-captif.crans.org;

    access_log      /var/log/nginx/portail_captif.log;
    error_log       /var/log/nginx/portail_captif_error.log;

    set_real_ip_from 10.231.137.0/24;
    real_ip_header P-Real-Ip;


}


server {
    listen          80;
    listen [::]:80;

    server_name portail-captif.crans.org;

    return 301 https://portail-captif.crans.org;

    access_log      /var/log/nginx/portail_captif.log;
    error_log       /var/log/nginx/portail_captif_error.log;

    set_real_ip_from 10.231.137.0/24;
    real_ip_header P-Real-Ip;

    client_max_body_size 160M; # allows file uploads up to 160 megabytes
    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
        proxy_set_header Host portail-captif.crans.org;
        proxy_redirect off;

        proxy_pass http://app_server;
    }

    location /static {
    expires 1M;
        alias "/var/www/django-portail-captif/static_files/";
    }

}

server {
    listen 443;
    listen [::]:443;

    server_name portail-captif.crans.org;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/portail-captif.crans.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/portail-captif.crans.org/privkey.pem;
    keepalive_timeout    70;

    access_log      /var/log/nginx/portail_captif.log;
    error_log       /var/log/nginx/portail_captif_error.log;

    set_real_ip_from 10.231.136.0/24;
    set_real_ip_from 2a0c:700:0:2::/64;
    real_ip_header P-Real-Ip;

    client_max_body_size 160M; # allows file uploads up to 160 megabytes
    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host portail-captif.crans.org;
        proxy_redirect off;

        proxy_pass http://app_server;
    }
    location /static {
    expires 1M;
        alias "/var/www/django-portail-captif/static_files/";
    }

}


